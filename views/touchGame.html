<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0">
    <title>123_미니게임</title>

    <style>
        body,
        html {
            height: 100%;
            margin: 0;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background-color: #b4a8ff;
            /* 연보라색 배경 */
            font-family: 'Comic Sans MS', cursive, sans-serif;
            /* 귀여운 폰트 */
        }

        canvas {
            border: 15px groove #f0ec0a;
            /* 연보라색 테두리 */
            border-radius: 10px;
            /* 둥근 모서리 */
            cursor: crosshair;
            background-color: #fff;
            /* 캔버스 배경색 */
        }

        #resetBtn,
        #mainBtn,
        #prevBtn,
        #nextBtn {
            height: 50px;
            width: 150px;
            padding: 10px 20px;
            font-size: 16px;
            border: none;
            border-radius: 5px;
            background-color: red;
            /* 연보라색 버튼 */
            color: #fff;
            cursor: pointer;
            margin: 5px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            /* 버튼 그림자 */
            transition: background-color 0.3s, transform 0.3s;
        }

        #resetBtn:hover,
        #mainBtn:hover,
        #prevBtn:hover,
        #nextBtn:hover {
            background-color: #923b7f;
            /* 다크 연보라색 */
        }

        #resetBtn:active,
        #mainBtn:active,
        #prevBtn:active,
        #nextBtn:active {
            transform: scale(0.95);
            /* 클릭 시 버튼 축소 효과 */
        }

        .gameModal {
            display: none;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.4);
            /* 검은색 배경 투명도 */
            justify-content: center;
            align-items: center;
        }

        .modalContent {
            background-color: #fff;
            margin: auto;
            padding: 20px;
            border: 1px solid #d4a0d1;
            /* 연보라색 테두리 */
            width: 80%;
            max-width: 500px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            /* 모달 그림자 */
        }

        .gameModalClose {
            color: #ff6d33;
            float: right;
            font-size: 40px;
            font-weight: bold;
            cursor: pointer;
        }

        .gameModalClose:hover {
            color: #ff6d33;
            /* 다크 연보라색 */
        }

        .controls {
            margin-top: 20px;
            text-align: center;
        }

        #modalGameImage {
            width: 100%;
            max-width: 100%;
            height: auto;
            border-radius: 10px;
            /* 이미지 둥근 모서리 */
        }

        h3,
        h5 {
            color: #000000;
            /* 연보라색 텍스트 */
            text-align: center;
        }

        /* 여기 하는 중 */
        /* 모달의 기본 스타일 */
        .gameModal {
            display: none;
            /* 기본적으로 숨김 */
            position: fixed;
            /* 고정 위치 */
            z-index: 1;
            /* 위에 표시 */
            left: 0;
            top: 0;
            width: 100%;
            /* 전체 너비 */
            height: 100%;
            /* 전체 높이 */
            overflow: auto;
            /* 필요한 경우 스크롤 활성화 */
            background-color: rgba(0, 0, 0, 0.4);
            /* 반투명 검정 배경 */
        }

        .modalContent {
            background-color: #FFD700;
            /* 노란색 배경 */
            margin: 15% auto;
            /* 위에서 15% 떨어져서 중앙 정렬 */
            padding: 20px;
            border-radius: 20px;
            /* 둥근 모서리 */
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            /* 그림자 추가 */
            width: 450px;
            /* 너비 설정 */
            height: 400px;
            max-width: 500px;
            /* 최대 너비 */
            text-align: center;
            /* 텍스트 중앙 정렬 */
        }

        /* 닫기 버튼 스타일 */
        .gameModalClose {
            color: #050505;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .gameModalClose:hover,
        .gameModalClose:focus {
            color: black;
            text-decoration: none;
        }

        /* 컨트롤 버튼 스타일 */
        .controls button {
            background-color: #ffffff;
            /* 흰색 배경 */
            border: none;
            color: #333;
            /* 어두운 텍스트 색상 */
            padding: 10px 20px;
            margin: 10px;
            border-radius: 15px;
            /* 둥근 버튼 */
            cursor: pointer;
            font-size: 16px;
        }

        .controls button:hover {
            background-color: #ffeb3b;
            /* 호버 시 약간 어두운 노란색 */
        }

        /* 모달 이미지 스타일 */
        #modalGameImage {
            width: 100%;
            height: auto;
            border-radius: 10px;
            /* 이미지의 둥근 모서리 */
            margin-bottom: 15px;
        }

        #modalGameText {
            font-family: 'Freesentation-9Black', sans-serif;
            font-weight: 900;
            font-size: 24px;
            margin: 15px 0;
            color: #000000;
            /* 대비를 위한 어두운 텍스트 */
        }

        .startModal {
            display: flex;
            /* 기본적으로 숨김 상태 */
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            /* 반투명 검정 배경 */
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        /* 모달 콘텐츠 스타일 */
        .startcontent {
            font-family: 'Freesentation-9Black', sans-serif;
            font-weight: 900;
            font-size: 4em;
            background: #ffe600;
            border-radius: 15px;
            padding: 20px;

            width: 500px;
            height: 320px;
            text-align: center;
            position: relative;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }



        .startimg {
            width: 250px;
            height: 250px;
            position: absolute;
            top: -130px;
            /* 이미지 상단 위치 조정 */
            left: 55%;
            transform: translateX(-50%);

        }

        #startGameBtn {
            background-color: red;
            color: white;
            font-size: 0.6em;
            /* padding: 10px 20px; */
            border: none;
            padding: 10px;
            border-radius: 5px;
            cursor: pointer;


        }


        #starttext {
            font-size: 0.3em;
            /* 글씨 작게 설정 */
            margin-top: -20px;
            color: #000;


        }

        #starttext1{
            margin-top: 30px;
            line-height:30px;
        }

        .innerModal {
            background-color: #fff;
            /* 흰색 배경 */
           
            border-radius: 10px;
            /* 둥근 모서리 */
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.1);
            /* 가벼운 그림자 */
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 500px;
            height: 180px;
            text-align: center;
        }
    </style>
</head>

<body>

    <div id="startModal" class="startModal">
        <div class="startcontent">

            <img src="/pic/pic.png" alt="logo" class="startimg">
            <div class="innerModal">
            <h5 id="starttext1">낱말-그림 게임</h5>
            <div id="starttext">그림에 알맞은 음식메뉴에 선을 그어 연결해주세요.
                <button id="startGameBtn">게임시작</button>
            </div>
            </div>
            
            
        </div>

    </div>

    <canvas id="canvas" width="720" height="1280"></canvas>

    <div id="gameModal" class="gameModal">
        <div class="modalContent">
            <span class="gameModalClose">&times;</span>
            <img id="modalGameImage" src="" alt="게임 이미지" />
            <h3 id="modalGameText">게임 제목</h3>
            <h5 id="modalGameText">여기 설명 작성하기 태그는 편하게 변경</h5>
            <div class="controls">
                <button id="prevBtn">이전</button>
                <button id="nextBtn">다음</button>
            </div>
            <div class="controls">
                <button id="resetBtn">다시하기</button>
                <button id="mainBtn">처음으로</button>
            </div>
        </div>
    </div>

    <!-- <script src="/touchGame.js"> -->
    // 모달 기능 처리용 JavaScript
    <script>
        const modal = document.getElementById("gameModal");
        const closeModal = document.querySelector(".gameModalClose");

        // 닫기 버튼 클릭 시 모달 닫기
        closeModal.onclick = function () {
            modal.style.display = "none";
        }

        // 모달 외부 클릭 시 모달 닫기
        window.onclick = function (event) {
            if (event.target == modal) {
                modal.style.display = "none";
            }
        }

        // ==================================================== 게임 관련 ==========================================
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');

        let isDrawing = false;  // 선이 그려지는 중인가?
        let startX, startY;     // 시작 좌표
        const images = [];
        let lines = []; // 그려진 선들의 배열
        // ==================================================== 게임 관련 ===========================================

        // ==================================================== 모달 관련 ===========================================
        const gameModal = document.getElementById('gameModal');
        const closeBtn = document.querySelector('.gameModalClose');
        const startGameBtn = document.getElementById('startGameBtn');
        const startModal = document.getElementById('startModal');

        const modalGameImage = document.getElementById('modalGameImage');
        const modalGameText = document.getElementById('modalGameText');
        const resetBtn = document.getElementById('resetBtn');
        const mainBtn = document.getElementById('mainBtn');
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');

        let imgTextName;
        let currentIndex;
        let resCnt;

        // =========================================================================================================

        document.addEventListener('DOMContentLoaded', () => {
            fetch('/game/data')
                .then(response => response.json())
                .then(data => {
                    roadimagesData(data);
                })
                .catch(error => {
                    console.error('Error fetching data:', error);
                });
        });

        function roadimagesData(imagesDatas) {
            resCnt = 0;
            currentIndex = 0;
            imgTextName = [];
            imagesDatas.forEach((data, index) => {
                const img = new Image();
                img.onload = function () {
                    img.name = data.IMG_NAME;
                    imgTextName.push(data.IMG_NAME);
                    images[index] = img;
                    if (images.length === imagesDatas.length) {
                        imgTextName = shuffleArray(imgTextName);
                        startGameBtn.addEventListener('touchstart', () => {
                            startModal.style.display = 'none';
                            drawImages();
                        })
                    }
                };

                img.onerror = function () {
                    console.error(`Failed to load image: ${data.IMG_PATH}`);
                };
                let imgPath = data.IMG_GROUP + data.IMG_PATH;
                img.src = imgPath;
            });
        }

        function drawImages() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            images.forEach((img, index) => {
                const x = 30;
                const y = 30 + index * 260;

                ctx.strokeStyle = '#ff6d33';
                ctx.lineWidth = 5;

                ctx.drawImage(img, x, y, 250, 180);
                // ctx.shadowColor = '#ff6d33' //그림자 색깔

                ctx.shadowOffsetX = 5  //x축 길이?
                ctx.shadowOffsetY = 5  //y축 길이
                // ctx.strokeRect(x, y, 250, 180);

                ctx.fillStyle = '#000';
                ctx.font = '18px Arial';
                ctx.textAlign = 'center';
                // ctx.strokeStyle = '#000';

                ctx.strokeRect(x + 445, y + 63, 230, 40);
                ctx.fillText(imgTextName[index], x + 560, y + 90);
            });
        }

        function shuffleArray(array) {
            const newArray = array.slice()
            for (let i = newArray.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
            }
            return newArray;
        }

        canvas.addEventListener('touchstart', startDrawing);
        canvas.addEventListener('touchmove', drawLine);
        canvas.addEventListener('touchend', stopDrawing);

        function startDrawing(event) {
            // 선 컬러 두께는 여기서 설정해주기
            isDrawing = true;
            lines.push([]);
            const touch = event.touches[0];
            startX = touch.clientX - canvas.getBoundingClientRect().left;
            startY = touch.clientY - canvas.getBoundingClientRect().top;
        }

        function drawLine(event) {
            if (!isDrawing) return;
            event.preventDefault(); // 터치 이벤트가 발생하면 기본 마우스 이벤트를 방지합니다.
            const currentLine = lines[lines.length - 1];
            const touch = event.touches[0];
            const x = touch.clientX - canvas.getBoundingClientRect().left;
            const y = touch.clientY - canvas.getBoundingClientRect().top;
            const previousPoint = currentLine.length > 0 ? currentLine[currentLine.length - 1] : { x: startX, y: startY };

            // ctx.lineWidth = 5;
            // ctx.lineCap = 'round';
            // // ctx.strokeStyle = '#red';

            ctx.beginPath();
            ctx.moveTo(previousPoint.x, previousPoint.y);
            ctx.lineTo(x, y);
            ctx.stroke();

            currentLine.push({ x, y });
        }

        function stopDrawing() {
            isDrawing = false;
        }

        let downName = '';

        canvas.addEventListener('touchstart', function (event) {
            const rect = canvas.getBoundingClientRect();
            const touch = event.touches[0];
            const mouseX = touch.clientX - rect.left;
            const mouseY = touch.clientY - rect.top;

            images.forEach((img) => {
                const imgX = 30;
                const imgY = 30 + images.indexOf(img) * 260;
                const imgWidth = 250;
                const imgHeight = 180;

                if (mouseX >= imgX && mouseX <= imgX + imgWidth &&
                    mouseY >= imgY && mouseY <= imgY + imgHeight) {
                    downName = img.name;
                    console.log(`클릭된 위치의 이미지 이름: ${img.name}`);
                }
            });
        });

        let upName = '';

        canvas.addEventListener('touchend', function (event) {
            const rect = canvas.getBoundingClientRect();
            const touch = event.changedTouches[0];
            const mouseX = touch.clientX - rect.left;
            const mouseY = touch.clientY - rect.top;

            images.forEach((img, index) => {
                const imgX = 560;
                const imgY = 93 + images.indexOf(img) * 260;
                const imgWidth = 230;
                const imgHeight = 40;

                if (mouseX >= imgX && mouseX <= imgX + imgWidth &&
                    mouseY >= imgY && mouseY <= imgY + imgHeight) {
                    upName = imgTextName[index];
                    console.log(`마우스 업된 위치의 이미지 이름: ${upName}`);
                }
            });

            if (upName == downName && upName != '' && downName != '') {
                alert("정답입니다.")
                resCnt += 1;
            } else {
                if (lines.length > 0) {
                    alert("오답입니다. 다시한번 시도해보세요");
                    const lastLine = lines.pop();
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    drawImages();
                    lines.forEach(line => {
                        ctx.beginPath();
                        ctx.moveTo(line[0].x, line[0].y);
                        line.forEach(point => {
                            ctx.lineTo(point.x, point.y);
                        });
                        ctx.stroke();
                    });
                }
            }
            if (resCnt == 5) {
                modalGameImage.src = images[0].src;
                modalGameText.innerText = images[0].name;
                gameModal.style.display = 'flex'; // 모달을 보이게 설정
            }
        });

        // ==================================================== 모달 관련 ===========================================

        // 게임 초기화
        resetBtn.addEventListener('touchstart', () => {
            gameModal.style.display = 'none';
            location.href = '/game';
        })

        // 메인화면으로 이동
        mainBtn.addEventListener('touchstart', () => {
            gameModal.style.display = 'none';
            location.href = '/';
        })

        closeBtn.addEventListener('touchstart', () => {
            gameModal.style.display = 'none'; // 모달을 숨김
        });

        window.addEventListener('touchstart', (event) => {
            if (event.target === gameModal) {
                gameModal.style.display = 'none'; // 모달 외부를 클릭했을 때 모달을 숨김
            }
        });

        // modalImage 변경하기
        function showImage(index) {
            modalGameImage.src = images[index].src;
            modalGameText.innerText = images[index].name;
        }

        // 모달 이미지 prev
        prevBtn.addEventListener('touchstart', () => {
            currentIndex = (currentIndex > 0) ? currentIndex - 1 : images.length - 1;
            showImage(currentIndex);
        });

        // 모달 이미지 next
        nextBtn.addEventListener('touchstart', () => {
            currentIndex = (currentIndex < images.length - 1) ? currentIndex + 1 : 0;
            showImage(currentIndex);
        });

    </script>
</body>

</html>